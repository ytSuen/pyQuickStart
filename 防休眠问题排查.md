# 防休眠功能问题排查指南

## 问题描述

从日志看，防休眠功能每55秒（现已改为30秒）都在执行模拟按键，但电脑仍然进入了休眠/锁屏状态。

## 已实施的改进

### v1.1.1 改进（最新版本）

**四重防护机制：**

1. **鼠标事件触发** - `mouse_event(0, 0)` 移动0像素
   - 最可靠的方法，直接触发系统输入事件
   
2. **重置空闲计时器** - `SetThreadExecutionState(ES_SYSTEM_REQUIRED | ES_DISPLAY_REQUIRED)`
   - 不带 ES_CONTINUOUS，单次重置计时器
   
3. **模拟按键** - Shift 键按下并释放
   - 通过 pynput 库模拟真实按键
   
4. **恢复持续状态** - 重新设置 ES_CONTINUOUS 标志
   - 确保持续防护状态

**刷新间隔：** 从 55 秒缩短到 30 秒

## 可能的原因分析

### 1. 锁屏 ≠ 休眠

**症状：** 屏幕变黑，需要输入密码

**原因：** 这可能是**自动锁屏**而不是休眠

**区别：**
- **锁屏**：系统仍在运行，只是锁定了屏幕
- **休眠**：系统进入低功耗状态，内存保存到硬盘

**检查方法：**
```cmd
# 查看锁屏设置
reg query "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System" /v InactivityTimeoutSecs
```

**解决方法：**
- 锁屏是由组策略或屏幕保护程序控制的
- 防休眠功能**无法阻止锁屏**
- 需要在 Windows 设置中关闭自动锁屏

### 2. Windows 电源计划设置

**症状：** 固定时间后进入休眠

**原因：** 电源计划设置了强制休眠时间

**检查方法：**
```cmd
# 运行诊断脚本
检查电源设置.bat

# 或手动查询
powercfg /query SCHEME_CURRENT SUB_SLEEP STANDBYIDLE
```

**解决方法：**
```cmd
# 设置接通电源时从不休眠
powercfg /change standby-timeout-ac 0

# 设置使用电池时从不休眠（笔记本）
powercfg /change standby-timeout-dc 0

# 设置显示器从不关闭
powercfg /change monitor-timeout-ac 0
```

### 3. 组策略强制休眠

**症状：** 无法修改电源设置，或修改后自动恢复

**原因：** 企业环境的组策略限制

**检查方法：**
```cmd
# 打开组策略编辑器
gpedit.msc

# 查看路径：
# 计算机配置 > 管理模板 > 系统 > 电源管理 > 睡眠设置
```

**解决方法：**
- 联系 IT 管理员
- 或使用管理员权限修改组策略

### 4. 快速启动功能

**症状：** 看起来像休眠，但实际是快速启动

**原因：** Windows 的"快速启动"功能

**检查方法：**
- 控制面板 > 电源选项 > 选择电源按钮的功能
- 查看"启用快速启动"是否勾选

**解决方法：**
- 取消勾选"启用快速启动"
- 或接受这个功能（不影响防休眠）

### 5. 屏幕保护程序

**症状：** 屏幕变黑并锁定

**原因：** 屏幕保护程序设置了"恢复时显示登录屏幕"

**检查方法：**
- 右键桌面 > 个性化 > 锁屏界面 > 屏幕保护程序设置

**解决方法：**
- 取消勾选"在恢复时显示登录屏幕"
- 或设置屏幕保护程序为"无"

## 测试步骤

### 1. 重新打包并测试

```cmd
# 关闭旧程序
强制关闭并打包.bat

# 测试新版本
测试新版本防休眠.bat
```

### 2. 检查日志

打开日志文件：`logs\hotkey_YYYYMMDD.log`

**正常日志应该显示：**
```
2026-01-23 10:00:00,000 [INFO] 防休眠刷新完成 (鼠标事件 + 重置计时器 + 模拟按键 + 恢复状态)
2026-01-23 10:00:30,000 [INFO] 防休眠刷新完成 (鼠标事件 + 重置计时器 + 模拟按键 + 恢复状态)
2026-01-23 10:01:00,000 [INFO] 防休眠刷新完成 (鼠标事件 + 重置计时器 + 模拟按键 + 恢复状态)
```

**如果看到：**
- 每30秒一次刷新 → 功能正常运行
- 间隔不规律 → 可能有问题
- 没有刷新记录 → 防休眠未启动

### 3. 检查系统设置

```cmd
# 运行诊断
检查电源设置.bat
```

查看输出，重点关注：
- **显示器关闭时间**：应该是"从不"或很长时间
- **系统休眠时间**：应该是"从不"或很长时间
- **锁屏时间**：如果设置了，防休眠无法阻止

### 4. 长时间测试

1. 开启防休眠
2. 最小化程序
3. 等待 10-15 分钟
4. 观察是否休眠/锁屏

**如果仍然休眠/锁屏：**
- 记录准确的时间（几分钟后发生）
- 检查是锁屏还是休眠
- 查看日志最后的时间戳

## 终极解决方案

如果以上方法都无效，可以尝试：

### 方案 1：禁用所有休眠功能

```cmd
# 以管理员身份运行
powercfg /change standby-timeout-ac 0
powercfg /change standby-timeout-dc 0
powercfg /change monitor-timeout-ac 0
powercfg /change monitor-timeout-dc 0
powercfg /change hibernate-timeout-ac 0
powercfg /change hibernate-timeout-dc 0
```

### 方案 2：使用 Caffeine 模式

修改代码，使用更激进的防休眠策略：

```python
# 在 power_manager.py 中
# 将刷新间隔改为 15 秒
self._keyboard_simulation_interval = 15
```

### 方案 3：检查是否是锁屏而非休眠

如果是锁屏问题，需要：

1. **关闭自动锁屏：**
   - 设置 > 账户 > 登录选项
   - "需要登录" 设置为 "从不"

2. **关闭屏幕保护程序：**
   - 右键桌面 > 个性化 > 锁屏界面
   - 屏幕保护程序设置 > 选择"无"

3. **关闭动态锁定：**
   - 设置 > 账户 > 登录选项
   - 取消勾选"动态锁定"

## 日志分析

### 你的日志显示：

```
2026-01-23 09:49:09,940 [INFO] 手动开启防休眠
2026-01-23 09:50:04,924 [INFO] 模拟按键操作完成 (Shift)
2026-01-23 09:50:59,935 [INFO] 模拟按键操作完成 (Shift)
...
2026-01-23 10:09:20,109 [INFO] 模拟按键操作完成 (Shift)
2026-01-23 10:09:22,468 [INFO] 开始停止快捷键监听
```

**分析：**
1. ✓ 防休眠功能正常启动
2. ✓ 每55秒执行一次模拟按键
3. ✓ 持续运行了约20分钟
4. ✓ 最后手动停止

**结论：**
- 功能本身运行正常
- 但仍然发生了休眠/锁屏
- **很可能是锁屏而不是休眠**
- 或者是电源计划的强制设置

## 建议

1. **首先确认是锁屏还是休眠**
   - 锁屏：屏幕黑，但电脑仍在运行，风扇转动
   - 休眠：电脑完全关闭，需要按电源键唤醒

2. **如果是锁屏**
   - 防休眠功能无法阻止锁屏
   - 需要在 Windows 设置中关闭自动锁屏

3. **如果是休眠**
   - 使用新版本（已改进为四重防护）
   - 检查电源设置
   - 手动禁用休眠功能

4. **测试新版本**
   - 运行 `测试新版本防休眠.bat`
   - 观察日志是否显示"防休眠刷新完成"
   - 等待更长时间（15-20分钟）

## 技术细节

### 为什么模拟按键可能无效？

1. **Windows 10/11 的智能休眠**
   - 系统会检测"真实"的用户活动
   - 某些情况下会忽略程序模拟的输入

2. **组策略优先级**
   - 组策略设置优先级高于 API 调用
   - 企业环境可能有强制休眠策略

3. **锁屏与休眠的区别**
   - 锁屏由安全策略控制
   - 防休眠 API 无法阻止锁屏

### 新版本的改进

1. **鼠标事件** - 比按键更可靠
2. **重置计时器** - 直接重置系统空闲时间
3. **更频繁刷新** - 30秒一次，确保在休眠前刷新
4. **多重保险** - 四种方法同时使用

## 下一步

1. 使用新版本测试
2. 运行 `检查电源设置.bat` 查看系统配置
3. 确认是锁屏还是休眠
4. 根据情况调整 Windows 设置
5. 如果仍有问题，提供详细的日志和系统信息
