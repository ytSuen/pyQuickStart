# 实现计划: 快捷键启动与防休眠工具

## 概述

本实现计划基于现有的Python代码库，重点是添加完善的测试覆盖（单元测试和属性测试），修复潜在问题，并确保所有正确性属性得到验证。现有代码已经实现了核心功能，我们将通过测试驱动的方式验证和改进代码质量。

## 任务

- [x] 1. 设置测试框架和项目结构
  - 安装pytest和Hypothesis测试库
  - 创建tests目录结构
  - 配置pytest.ini和测试环境
  - _需求: 所有需求的测试基础_

- [x] 1.1 编写属性测试：配置持久化往返一致性
  - **属性 1: 配置持久化往返一致性**
  - **验证: 需求 4.1, 4.2, 4.5**
  - 生成随机配置数据（包含Unicode字符）
  - 测试保存后加载的一致性
  - 最少100次迭代

- [x] 1.2 编写单元测试：ConfigManager基础功能
  - 测试配置文件创建
  - 测试add_hotkey和remove_hotkey方法
  - 测试损坏文件处理
  - _需求: 4.3, 4.4_

- [x] 2. 实现和测试快捷键管理器
  - [x] 2.1 增强HotkeyManager的输入验证
    - 添加快捷键格式验证逻辑
    - 添加文件扩展名检查
    - 添加修饰键检测
    - _需求: 1.1, 2.5, 10.1, 10.5_

  - [x] 2.2 编写属性测试：快捷键格式验证
    - **属性 5: 快捷键格式验证**
    - **验证: 需求 1.1, 10.5**
    - 生成各种格式的快捷键字符串
    - 验证无修饰键的被拒绝
    - 最少100次迭代

  - [x] 2.3 编写属性测试：快捷键大小写不敏感
    - **属性 6: 快捷键大小写不敏感**
    - **验证: 需求 10.4**
    - 生成随机大小写组合的快捷键
    - 验证等价性
    - 最少100次迭代

  - [x] 2.4 编写属性测试：文件类型限制
    - **属性 7: 文件类型限制**
    - **验证: 需求 2.5**
    - 生成各种文件扩展名的路径
    - 验证只接受.exe文件
    - 最少100次迭代

  - [x] 2.5 编写单元测试：快捷键添加和移除
    - 测试正常添加流程
    - 测试快捷键冲突处理
    - 测试无效路径拒绝
    - _需求: 1.2, 2.4_

- [x] 3. 实现和测试进程管理功能
  - [x] 3.1 增强launch_program的重复检测逻辑
    - 改进进程名称匹配算法
    - 添加更健壮的进程检测
    - _需求: 2.2_

  - [x] 3.2 编写属性测试：重复启动防护
    - **属性 4: 重复启动防护**
    - **验证: 需求 2.2**
    - 模拟程序已运行的场景
    - 验证不创建新进程
    - 最少100次迭代

  - [x] 3.3 编写属性测试：进程监控准确性
    - **属性 2: 进程监控准确性**
    - **验证: 需求 9.1, 9.3, 9.4**
    - 模拟进程启动和结束
    - 验证计数准确性
    - 最少100次迭代

  - [x] 3.4 编写单元测试：进程监控线程
    - 测试_monitor_processes方法
    - 测试进程清理逻辑
    - 测试get_running_count方法
    - _需求: 3.5, 9.2_

- [x] 4. 检查点 - 确保核心功能测试通过
  - 运行所有已实现的测试
  - 确认测试覆盖率达标
  - 如有问题请询问用户

- [x] 5. 实现和测试电源管理功能
  - [x] 5.1 验证PowerManager的Windows API调用
    - 确认SetThreadExecutionState正确调用
    - 添加状态跟踪日志
    - _需求: 3.1, 3.2, 3.3_

  - [x] 5.2 编写属性测试：防休眠状态一致性
    - **属性 3: 防休眠状态一致性**
    - **验证: 需求 3.1, 3.2**
    - 模拟不同数量的运行程序
    - 验证防休眠状态正确切换
    - 最少100次迭代

  - [x] 5.3 编写单元测试：PowerManager基础功能
    - 测试prevent_sleep方法
    - 测试allow_sleep方法
    - 测试析构函数清理
    - _需求: 3.4, 7.2_

- [x] 6. 实现和测试日志记录功能
  - [x] 6.1 验证Logger单例模式实现
    - 确认单例模式正确性
    - 添加线程安全保护（如需要）
    - _需求: 7.5_

  - [x] 6.2 编写属性测试：Logger单例一致性
    - **属性 9: Logger单例一致性**
    - **验证: 需求 7.5**
    - 多次创建Logger实例
    - 验证返回同一对象
    - 最少100次迭代

  - [x] 6.3 编写属性测试：日志记录完整性
    - **属性 8: 日志记录完整性**
    - **验证: 需求 2.3, 3.3, 6.1, 6.2**
    - 触发各种操作
    - 验证日志条目存在
    - 最少100次迭代

  - [x] 6.4 编写单元测试：日志文件管理
    - 测试日志文件创建
    - 测试日志格式
    - 测试不同级别的日志
    - _需求: 6.3, 6.4, 6.5_

- [x] 7. 实现和测试GUI功能
  - [x] 7.1 增强GUI的错误处理和用户反馈
    - 改进错误对话框消息
    - 添加输入验证提示
    - 确保成功提示清晰
    - _需求: 8.1, 8.2, 8.3, 8.5_

  - [x] 7.2 编写属性测试：GUI状态同步
    - **属性 10: GUI状态同步**
    - **验证: 需求 5.5, 5.6, 5.7, 5.8**
    - 模拟状态变化
    - 验证UI显示一致性
    - 最少100次迭代

  - [x] 7.3 编写单元测试：GUI基础操作
    - 测试_add_hotkey方法
    - 测试_remove_hotkey方法
    - 测试_toggle_monitoring方法
    - 测试_browse_file方法
    - _需求: 5.1, 5.2, 5.3, 5.4_

  - [x] 7.4 编写单元测试：GUI状态更新线程
    - 测试_update_status方法
    - 测试状态标签更新
    - 测试进程计数更新
    - _需求: 5.7, 5.8_

- [x] 8. 实现和测试资源清理功能
  - [x] 8.1 验证资源清理逻辑
    - 确认_on_closing正确清理
    - 确认析构函数被调用
    - 添加清理日志
    - _需求: 7.1, 7.2, 7.3_

  - [x] 8.2 编写单元测试：资源清理
    - 测试窗口关闭事件
    - 测试快捷键注销
    - 测试防休眠恢复
    - _需求: 7.1, 7.2, 7.3_

- [x] 9. 实现和测试快捷键注册功能
  - [x] 9.1 编写属性测试：快捷键注册完整性
    - **属性 11: 快捷键注册完整性**
    - **验证: 需求 1.3**
    - 生成随机快捷键集合
    - 验证所有快捷键被注册
    - 最少100次迭代

  - [x] 9.2 编写单元测试：快捷键监听启动和停止
    - 测试start方法
    - 测试stop方法
    - 测试重复启动处理
    - _需求: 1.3, 1.4_

- [x] 10. 检查点 - 确保所有测试通过
  - 运行完整测试套件
  - 检查测试覆盖率报告
  - 修复任何失败的测试
  - 如有问题请询问用户

- [x] 11. 边界条件和错误处理测试
  - [x] 11.1 编写边界条件测试
    - 测试50个快捷键限制
    - 测试空配置文件
    - 测试损坏的JSON文件
    - 测试无效的Unicode字符
    - _需求: 1.5, 4.3, 4.4_

  - [x] 11.2 编写错误处理测试
    - 测试程序启动失败
    - 测试进程访问被拒绝
    - 测试Windows API调用失败
    - 测试文件系统错误
    - _需求: 2.4, 8.4_

- [x] 12. 集成测试和端到端测试
  - [x] 12.1 编写集成测试：完整工作流
    - 测试启动GUI → 添加快捷键 → 启动监听 → 验证功能
    - 测试配置持久化流程
    - 测试资源清理流程
    - _需求: 所有需求_

- [x] 13. 文档和代码质量改进
  - [x] 13.1 更新README文档
    - 添加测试运行说明
    - 添加开发指南
    - 更新依赖列表
    - _需求: 文档完善_

  - [x] 13.2 代码质量检查
    - 运行pylint或flake8
    - 修复代码风格问题
    - 添加类型注解（如需要）
    - _需求: 代码质量_

- [x] 14. 最终检查点
  - 确保所有测试通过（单元测试 + 属性测试）
  - 确认测试覆盖率 > 80%
  - 验证所有11个正确性属性
  - 手动测试核心功能
  - 询问用户是否有其他需求

## 注意事项

- 所有任务都是必需的，确保全面的测试覆盖
- 每个任务都引用了具体的需求编号以便追溯
- 属性测试使用Hypothesis库，最少100次迭代
- 单元测试使用pytest框架
- 检查点任务确保增量验证
- 现有代码已实现核心功能，重点是测试和验证

## 测试标签格式

所有属性测试必须使用以下注释格式：
```python
# Feature: hotkey-power-manager, Property {N}: {property_text}
```

例如：
```python
# Feature: hotkey-power-manager, Property 1: 配置持久化往返一致性
@given(st.dictionaries(st.text(), st.text()))
def test_config_roundtrip(config_data):
    # 测试实现
    pass
```
