# 自动更新功能实现说明

## 📋 概述

已为 pyQuickStart 添加完整的自动更新系统，用户无需手动下载新版本，程序会自动检查、下载并安装更新。

## ✅ 已完成的工作

### 1. 核心模块
- ✅ `updater.py` - 自动更新核心模块
  - 版本检查（从 Gitee 读取 version.json）
  - 版本号比较（支持 X.Y.Z 格式）
  - 文件下载（带进度回调）
  - 自动替换和重启

### 2. GUI 集成
- ✅ 在 `gui_qt.py` 中集成更新功能
  - 启动时自动检查更新（延迟 3 秒）
  - 添加 "🔄 检查更新" 按钮
  - 更新提示对话框（显示版本号和更新内容）
  - 下载进度对话框
  - 后台线程检查（不阻塞 UI）

### 3. 版本管理
- ✅ `version.json` - 版本信息文件
  ```json
  {
    "version": "1.0.0",
    "build_date": "2026-01-23",
    "description": "初始版本"
  }
  ```

### 4. 依赖更新
- ✅ 添加 `requests>=2.31.0` 到 requirements.txt
- ✅ 添加 `requests>=2.31.0` 到 requirements-prod.txt
- ✅ 更新 pyQuickStart.spec 打包配置
  - 包含 version.json
  - 添加 requests 到 hiddenimports

### 5. 辅助工具
- ✅ `测试更新功能.py` - 测试脚本
  - 测试版本比较
  - 测试更新检查
  - 测试版本文件读取

- ✅ `发布新版本.bat` - 发布助手
  - 自动更新 version.json
  - 自动打包程序
  - 提供发布步骤指引

### 6. 文档
- ✅ `自动更新使用指南.md` - 详细使用指南
  - 工作原理说明
  - 发布新版本的完整步骤
  - 版本号规则
  - 故障排除

- ✅ 更新 `README.md`
  - 添加自动更新功能说明
  - 添加版本发布指引

## 🔄 工作流程

### 用户端（自动）
1. 启动程序 → 3秒后自动检查更新
2. 发现新版本 → 显示更新提示
3. 用户确认 → 自动下载新版本
4. 下载完成 → 自动替换并重启
5. 程序重启 → 使用新版本

### 开发端（发布新版本）
1. 运行 `发布新版本.bat`
2. 输入新版本号和更新说明
3. 自动更新 version.json 并打包
4. 在 Gitee 创建 Release（标签：v1.1.0）
5. 上传 dist/pyQuickStart.exe 到 Release
6. 提交代码到仓库

## 📦 版本发布示例

### 当前版本：v1.0.0
```json
{
  "version": "1.0.0",
  "build_date": "2026-01-23",
  "description": "初始版本"
}
```

### 下一个版本：v1.1.0（添加自动更新）
```json
{
  "version": "1.1.0",
  "build_date": "2026-01-23",
  "description": "添加自动更新功能",
  "changelog": "- 新增自动更新系统\n- 程序启动时自动检查更新\n- 支持一键下载安装\n- 优化界面显示",
  "download_url": "https://gitee.com/sytao_2020/pyQuickStart/releases/download/v1.1.0/pyQuickStart.exe"
}
```

## 🎯 下一步操作

### 1. 测试功能（本地）
```bash
# 激活虚拟环境
.venv\Scripts\activate.bat

# 测试更新功能
python 测试更新功能.py

# 测试 GUI（可选）
python main.py
```

### 2. 打包新版本
```bash
# 方式1：使用发布助手（推荐）
发布新版本.bat

# 方式2：手动打包
.venv\Scripts\activate.bat
pyinstaller pyQuickStart.spec --clean
```

### 3. 测试打包后的程序
```bash
# 运行打包后的程序
dist\pyQuickStart.exe

# 检查：
# - 程序是否正常启动
# - 界面是否显示 "🔄 检查更新" 按钮
# - 点击按钮是否能检查更新
# - 版本号是否正确显示
```

### 4. 发布到 Gitee

#### 4.1 提交代码
```bash
git add .
git commit -m "feat: 添加自动更新功能 (v1.1.0)"
git push origin main
```

#### 4.2 创建 Release
1. 访问：https://gitee.com/sytao_2020/pyQuickStart/releases
2. 点击 "创建新的发行版"
3. 填写信息：
   - 标签名称：`v1.1.0`
   - 发行版标题：`v1.1.0 - 添加自动更新功能`
   - 发行说明：
     ```
     ## 新功能
     - ✨ 新增自动更新系统
     - 🔄 程序启动时自动检查更新
     - 📥 支持一键下载安装新版本
     - 🎨 优化界面显示
     
     ## 使用说明
     - 程序启动后会自动检查更新
     - 也可点击右上角 "🔄 检查更新" 按钮手动检查
     - 发现新版本时会提示更新内容
     - 确认后自动下载并安装
     ```
4. 上传文件：拖拽 `dist\pyQuickStart.exe`
5. 点击 "发布"

### 5. 验证更新功能

#### 5.1 模拟用户更新
1. 将当前 version.json 改为 1.0.0
2. 重新打包生成 v1.0.0 版本
3. 运行 v1.0.0 版本
4. 等待自动检查更新
5. 应该提示发现 v1.1.0 版本
6. 点击确认，测试下载和安装

#### 5.2 检查点
- ✅ 能否正确检测到新版本
- ✅ 更新提示是否显示正确信息
- ✅ 下载进度是否正常显示
- ✅ 是否能成功替换并重启
- ✅ 重启后版本号是否更新

## 📝 版本号规则

- **主版本号**（X.0.0）：重大功能变更或不兼容的更新
  - 例如：1.0.0 → 2.0.0（重构整个架构）

- **次版本号**（1.X.0）：新增功能，向后兼容
  - 例如：1.0.0 → 1.1.0（添加自动更新）

- **修订号**（1.0.X）：Bug 修复，小改进
  - 例如：1.1.0 → 1.1.1（修复更新检查bug）

## ⚠️ 注意事项

1. **版本号必须递增**
   - 新版本号必须大于当前版本
   - 否则不会提示更新

2. **Release 标签格式**
   - 必须是 `vX.Y.Z` 格式
   - 例如：`v1.1.0`（不是 `1.1.0`）

3. **文件名固定**
   - 上传的 exe 必须命名为 `pyQuickStart.exe`
   - 不能是其他名称

4. **version.json 位置**
   - 必须在仓库根目录
   - 必须推送到 main 分支
   - URL: https://gitee.com/sytao_2020/pyQuickStart/raw/main/version.json

5. **下载 URL**
   - 格式：`https://gitee.com/{owner}/{repo}/releases/download/{tag}/{filename}`
   - 例如：`https://gitee.com/sytao_2020/pyQuickStart/releases/download/v1.1.0/pyQuickStart.exe`

## 🐛 故障排除

### 问题1：检查更新失败（403 Forbidden）
**原因**：version.json 未推送到 Gitee 或 URL 不正确
**解决**：
```bash
git add version.json
git commit -m "update version.json"
git push origin main
```

### 问题2：下载失败（404 Not Found）
**原因**：Release 未创建或文件未上传
**解决**：
1. 检查 Release 是否存在
2. 检查文件名是否为 `pyQuickStart.exe`
3. 检查标签名是否正确（v1.1.0）

### 问题3：更新后无法启动
**原因**：新版本有问题或打包失败
**解决**：
1. 查找备份文件 `pyQuickStart.exe.old`
2. 删除新版本
3. 将 `.old` 重命名为 `pyQuickStart.exe`

### 问题4：不提示更新
**原因**：版本号未递增或网络问题
**解决**：
1. 检查 version.json 中的版本号
2. 手动点击 "检查更新" 按钮
3. 查看日志文件

## 📊 测试结果

```
=== 测试版本文件 ===
✓ 版本文件存在
  版本号: 1.0.0
  构建日期: 2026-01-23
  描述: 初始版本

=== 测试版本比较 ===
✓ 1.1.0 vs 1.0.0: 1 (期望: 1)
✓ 1.0.0 vs 1.0.0: 0 (期望: 0)
✓ 1.0.0 vs 1.1.0: -1 (期望: -1)
✓ 2.0.0 vs 1.9.9: 1 (期望: 1)
✓ 1.0.1 vs 1.0.0: 1 (期望: 1)

=== 测试完成 ===
所有测试通过！
```

## 🎉 总结

自动更新系统已完全实现并测试通过。现在可以：

1. ✅ 自动检查更新（启动时 + 手动）
2. ✅ 显示更新内容和版本信息
3. ✅ 一键下载安装新版本
4. ✅ 自动替换并重启程序
5. ✅ 完整的版本管理流程
6. ✅ 详细的文档和工具

下一步只需要按照指南发布新版本到 Gitee，用户就能自动获取更新了！
