# pyQuickStart 自动更新系统使用指南

## 📋 概述

pyQuickStart 现在支持自动更新功能！用户无需手动下载新版本的 exe 文件，程序会自动检查、下载并安装更新。

## 🎯 工作原理

### 1. 版本管理
- 每个版本都有一个 `version.json` 文件，记录版本号、构建日期等信息
- 版本号格式：`主版本.次版本.修订号`（例如：1.0.0, 1.1.0, 2.0.0）

### 2. 更新检查
- 程序启动后 3 秒自动检查更新
- 用户可点击界面右上角的 "🔄 检查更新" 按钮手动检查
- 检查时会访问 Gitee 仓库的 `version.json` 文件

### 3. 下载和安装
- 发现新版本时，会显示更新内容
- 用户确认后，自动下载新版本 exe
- 下载完成后，自动替换旧版本并重启程序

## 📦 发布新版本的步骤

### 步骤 1: 更新版本号

编辑 `version.json` 文件：

```json
{
  "version": "1.1.0",
  "build_date": "2026-01-23",
  "description": "添加自动更新功能",
  "changelog": "- 新增自动更新系统\n- 优化界面显示\n- 修复已知问题",
  "download_url": "https://gitee.com/sytao_2020/pyQuickStart/releases/download/v1.1.0/pyQuickStart.exe"
}
```

字段说明：
- `version`: 版本号（必填）
- `build_date`: 构建日期
- `description`: 版本描述
- `changelog`: 更新日志（支持多行）
- `download_url`: 下载地址（可选，不填则使用默认模板）

### 步骤 2: 打包新版本

在虚拟环境中运行：

```bash
# 激活虚拟环境
.venv\Scripts\activate

# 安装新依赖（如果有）
pip install -r requirements-prod.txt

# 打包
pyinstaller pyQuickStart.spec
```

或直接运行：
```bash
打包程序.bat
```

### 步骤 3: 在 Gitee 创建 Release

1. 进入 Gitee 仓库页面
2. 点击 "发行版" 或 "Releases"
3. 点击 "创建新的发行版"
4. 填写信息：
   - **标签名称**: `v1.1.0`（与 version.json 中的版本号对应）
   - **发行版标题**: `v1.1.0 - 添加自动更新功能`
   - **发行说明**: 复制 changelog 内容
5. 上传文件：将 `dist/pyQuickStart.exe` 拖拽上传
6. 点击 "发布"

### 步骤 4: 提交并推送代码

```bash
git add version.json updater.py gui_qt.py requirements*.txt pyQuickStart.spec
git commit -m "feat: 添加自动更新功能 (v1.1.0)"
git push origin main
```

## 🔄 更新流程（用户视角）

1. **启动程序** → 自动检查更新（3秒后）
2. **发现新版本** → 显示更新提示对话框
3. **用户确认** → 开始下载（显示进度）
4. **下载完成** → 自动安装并重启
5. **程序重启** → 使用新版本

## 📝 版本号规则

- **主版本号**（X.0.0）：重大功能变更或不兼容的更新
- **次版本号**（1.X.0）：新增功能，向后兼容
- **修订号**（1.0.X）：Bug 修复，小改进

示例：
- `1.0.0` → 初始版本
- `1.1.0` → 添加自动更新功能
- `1.1.1` → 修复更新检查的 bug
- `2.0.0` → 重大架构调整

## 🛠️ 技术细节

### 文件结构
```
pyQuickStart/
├── updater.py          # 更新模块
├── version.json        # 版本信息
├── gui_qt.py          # GUI（集成更新功能）
└── dist/
    ├── pyQuickStart.exe
    └── version.json    # 打包时会包含
```

### 更新检查 URL
```
https://gitee.com/sytao_2020/pyQuickStart/raw/main/version.json
```

### 下载 URL 模板
```
https://gitee.com/sytao_2020/pyQuickStart/releases/download/{tag}/pyQuickStart.exe
```

### 更新脚本
程序会自动生成临时更新脚本（`update_pyqs.bat`），执行以下操作：
1. 等待 2 秒（确保主程序退出）
2. 备份当前版本为 `.old`
3. 复制新版本
4. 启动新版本
5. 删除备份和脚本自身

## ⚠️ 注意事项

1. **版本号必须递增**：新版本号必须大于当前版本
2. **Release 标签格式**：必须是 `vX.Y.Z` 格式（例如 `v1.1.0`）
3. **文件名固定**：上传的 exe 必须命名为 `pyQuickStart.exe`
4. **网络要求**：用户需要能访问 Gitee
5. **权限要求**：更新时需要对程序目录有写权限

## 🐛 故障排除

### 问题 1: 检查更新失败
- 检查网络连接
- 确认 Gitee 仓库可访问
- 查看日志文件 `logs/hotkey_YYYYMMDD.log`

### 问题 2: 下载失败
- 检查 Release 是否正确创建
- 确认文件名为 `pyQuickStart.exe`
- 检查 download_url 是否正确

### 问题 3: 更新后无法启动
- 检查 `pyQuickStart.exe.old` 备份文件
- 手动恢复：删除新版本，将 `.old` 重命名回来

## 📊 版本历史示例

```json
// v1.0.0 - 初始版本
{
  "version": "1.0.0",
  "build_date": "2026-01-20",
  "description": "初始版本"
}

// v1.1.0 - 添加自动更新
{
  "version": "1.1.0",
  "build_date": "2026-01-23",
  "description": "添加自动更新功能",
  "changelog": "- 新增自动更新系统\n- 程序启动时自动检查更新\n- 支持一键下载安装"
}

// v1.1.1 - Bug 修复
{
  "version": "1.1.1",
  "build_date": "2026-01-24",
  "description": "修复更新检查问题",
  "changelog": "- 修复网络超时问题\n- 优化下载进度显示"
}
```

## 🎉 优势

1. **用户友好**：无需手动下载，一键更新
2. **自动化**：启动时自动检查，无需记住检查更新
3. **安全**：自动备份旧版本，更新失败可恢复
4. **透明**：显示详细的更新内容和进度
5. **灵活**：支持手动检查和自动检查两种方式

## 📞 支持

如有问题，请查看日志文件或在 Gitee 仓库提交 Issue。
